name: Comprehensive Build Matrix

on:
  push:
    branches: [ master, development, pull-request/* ]
  pull_request:
    branches: [ master, pull-request/* ]

jobs:
  build-linux:
    name: ${{ matrix.compiler_config.id }} | C++${{ matrix.cpp_standard }} | NO_STL=${{ matrix.no_stl }} | Linux
    runs-on: ubuntu-22.04
    container: ${{ matrix.compiler_config.image }}
    strategy:
      fail-fast: false
      matrix:
        cpp_standard: ['03', '11', '14', '17', '20', '23']
        no_stl: ['ON', 'OFF']
        compiler_config:
          # GCC versions
          - { id: 'gcc9', image: 'gcc:9.5.0', cc: 'gcc', cxx: 'g++', supported_cpp_stds: ['03', '11', '14', '17'] }
          - { id: 'gcc11', image: 'gcc:11.4.0', cc: 'gcc', cxx: 'g++', supported_cpp_stds: ['03', '11', '14', '17', '20'] }
          - { id: 'gcc13', image: 'gcc:13.2.0', cc: 'gcc', cxx: 'g++', supported_cpp_stds: ['03', '11', '14', '17', '20', '23'] }
          # Clang versions
          - { id: 'clang12', image: 'clangbuiltlinux/ubuntu20.04-clang:12.0.1', cc: 'clang', cxx: 'clang++', supported_cpp_stds: ['03', '11', '14', '17', '20'] }
          - { id: 'clang14', image: 'clangbuiltlinux/ubuntu22.04-clang:14.0.6', cc: 'clang', cxx: 'clang++', supported_cpp_stds: ['03', '11', '14', '17', '20', '23'] }
          - { id: 'clang17', image: 'clangbuiltlinux/ubuntu22.04-clang:17.0.1', cc: 'clang', cxx: 'clang++', supported_cpp_stds: ['03', '11', '14', '17', '20', '23'] }

    steps:
    - name: Check C++ Standard Compatibility
      id: compatibility_check
      run: |
        is_supported="${{ contains(matrix.compiler_config.supported_cpp_stds, matrix.cpp_standard) }}"
        echo "Compiler: ${{ matrix.compiler_config.id }}"
        echo "C++ Standard: ${{ matrix.cpp_standard }}"
        echo "Supported by this compiler: ${{ join(matrix.compiler_config.supported_cpp_stds, ', ') }}"
        echo "Compatibility check result: $is_supported"
        echo "should_run=$is_supported" >> $GITHUB_OUTPUT

    - name: Checkout ETLCPP
      if: ${{ steps.compatibility_check.outputs.should_run == 'true' }}
      uses: actions/checkout@v4

    - name: Configure and Build
      if: ${{ steps.compatibility_check.outputs.should_run == 'true' }}
      env:
        ASAN_OPTIONS: "alloc_dealloc_mismatch=0,detect_leaks=0"
      run: |
        export CC=${{ matrix.compiler_config.cc }}
        export CXX=${{ matrix.compiler_config.cxx }}
        
        PARAM_CPP_STANDARD=${{ matrix.cpp_standard }}
        PARAM_ETL_FORCE_CPP03="OFF"
        if [ "${{ matrix.cpp_standard }}" = "03" ]; then
          PARAM_ETL_FORCE_CPP03="ON"
        fi

        echo "--- Configuration Details ---"
        echo "Compiler ID: ${{ matrix.compiler_config.id }}"
        echo "Docker Image: ${{ matrix.compiler_config.image }}" # Using matrix.compiler_config.image as container is specified at job level
        echo "C++ Standard (ETL_CXX_STANDARD): $PARAM_CPP_STANDARD"
        echo "NO_STL: ${{ matrix.no_stl }}"
        echo "ETL_FORCE_TEST_CPP03: $PARAM_ETL_FORCE_CPP03"
        echo "CC: $CC, CXX: $CXX"
        echo "--- Compiler Version ---"
        $CXX --version
        echo "--- CMake Version ---"
        cmake --version
        echo "---------------------------"

        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTS=ON \
          -DNO_STL=${{ matrix.no_stl }} \
          -DETL_USE_TYPE_TRAITS_BUILTINS=OFF \
          -DETL_USER_DEFINED_TYPE_TRAITS=OFF \
          -DETL_FORCE_TEST_CPP03=$PARAM_ETL_FORCE_CPP03 \
          -DETL_CXX_STANDARD=$PARAM_CPP_STANDARD
        
        cmake --build build -j $(nproc)

    - name: Run tests
      if: ${{ steps.compatibility_check.outputs.should_run == 'true' }}
      run: |
        echo "--- Running Tests ---"
        cd build
        ./test/etl_tests
